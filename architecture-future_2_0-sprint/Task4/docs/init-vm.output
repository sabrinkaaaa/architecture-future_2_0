# data.yandex_compute_image.ubuntu:
data "yandex_compute_image" "ubuntu" {
    created_at          = "2025-11-10T11:07:46Z"
    description         = "Ubuntu 22.04 lts v20251031030637"
    family              = "ubuntu-2204-lts"
    folder_id           = "standard-images"
    hardware_generation = [
        {
            generation2_features = []
            legacy_features      = [
                {
                    pci_topology = "PCI_TOPOLOGY_V2"
                },
            ]
        },
    ]
    id                  = "********************"
    image_id            = "********************"
    labels              = {
        "version" = "20251031030637"
    }
    min_disk_size       = 8
    name                = "ubuntu-22-04-lts-v20251110"
    os_type             = "linux"
    pooled              = true
    product_ids         = [
        "********************",
    ]
    size                = 2
    status              = "ready"
}

# null_resource.install-k3s:
resource "null_resource" "install-k3s" {
    id       = "********************"
    triggers = {
        "host" = "0.0.0.0"
    }
}

# yandex_compute_instance.future-vm:
resource "yandex_compute_instance" "future-vm" {
    created_at                = "2025-11-15T19:34:56Z"
    description               = null
    folder_id                 = "********************"
    fqdn                      = "********************.auto.internal"
    gpu_cluster_id            = null
    hardware_generation       = [
        {
            generation2_features = []
            legacy_features      = [
                {
                    pci_topology = "PCI_TOPOLOGY_V2"
                },
            ]
        },
    ]
    hostname                  = null
    id                        = "********************"
    labels                    = {}
    maintenance_grace_period  = null
    metadata                  = {
        "ssh-keys" = <<-EOT
            ubuntu:ssh-rsa <there-is-ssh-public-key> breadrock@pc.local
        EOT
    }
    name                      = "future-vm"
    network_acceleration_type = "standard"
    platform_id               = "standard-v3"
    service_account_id        = null
    status                    = "running"
    zone                      = "ru-central1-a"

    boot_disk {
        auto_delete = true
        device_name = "********************"
        disk_id     = "********************"
        mode        = "READ_WRITE"

        initialize_params {
            block_size  = 4096
            description = null
            image_id    = "********************"
            kms_key_id  = null
            name        = null
            size        = 30
            snapshot_id = null
            type        = "network-hdd"
        }
    }

    metadata_options {
        aws_v1_http_endpoint = 1
        aws_v1_http_token    = 2
        gce_http_endpoint    = 1
        gce_http_token       = 1
    }

    network_interface {
        index              = 0
        ip_address         = "10.0.0.22"
        ipv4               = true
        ipv6               = false
        ipv6_address       = null
        mac_address        = "d0:0d:c0:5c:35:9c"
        nat                = true
        nat_ip_address     = "10.0.0.9"
        nat_ip_version     = "IPV4"
        security_group_ids = []
        subnet_id          = "********************"
    }

    placement_policy {
        host_affinity_rules       = []
        placement_group_id        = null
        placement_group_partition = 0
    }

    resources {
        core_fraction = 50
        cores         = 2
        gpus          = 0
        memory        = 4
    }

    scheduling_policy {
        preemptible = false
    }
}

# yandex_vpc_network.default:
resource "yandex_vpc_network" "default" {
    created_at                = "2025-11-15T19:11:57Z"
    default_security_group_id = "********************"
    description               = null
    folder_id                 = "********************"
    id                        = "********************"
    labels                    = {}
    name                      = "future-network"
    subnet_ids                = [
        "e9bfqm28do3a2njepghm",
    ]
}

# yandex_vpc_subnet.default:
resource "yandex_vpc_subnet" "default" {
    created_at     = "2025-11-15T19:12:00Z"
    description    = null
    folder_id      = "********************"
    id             = "********************"
    labels         = {}
    name           = "future-subnet"
    network_id     = "********************"
    route_table_id = null
    v4_cidr_blocks = [
        "10.0.0.0/24",
    ]
    v6_cidr_blocks = []
    zone           = "ru-central1-a"
}


Outputs:

external_ip = "89.169.159.141"
kubeconfig = <<-EOT
    scp -i ~/.ssh/yc/id_rsa_terraform ubuntu@10.0.0.9:/home/ubuntu/k3s.yaml ./k3s.yaml
        sed -i 's/127.0.0.1/10.0.0.9/g' k3s.yaml
EOT
vm_public_ip = "10.0.0.9"
